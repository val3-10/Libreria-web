<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Booknest - Cliente</title>
  <link rel="stylesheet" href="styles.css"> <!-- Enlace a hoja de estilos -->
</head>
<body>
  <!-- Encabezado con botones -->
  <header>
    <div class="header-botones">
      <button class="btn-cerrar" onclick="volverAlLogin()">Cerrar Sesión</button>
      <button onclick="abrirCarrito()" class="btn-carrito">Mi carrito 🛒</button>
    </div>
  </header>

  <div class="container">

    <!-- Sección de catálogo -->
    <div class="seccion">
      <h2>Catálogo de Libros</h2>
      <div id="catalogoLibros" class="catalogo-libros"></div> <!-- Aquí se cargan los libros -->
    </div>

    <!-- Modal del carrito -->
    <div id="modalCarrito" class="modal">
      <div class="modal-contenido" style="width: 800px; max-height: 800px; overflow-y: auto;">
        <h3>Carrito de Compras</h3>
        <table id="tablaCarrito">
          <thead>
            <tr>
              <th>Libro</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody> <!-- Aquí se dibuja el carrito -->
        </table>
        <div style="text-align: right; margin-top: 10px;">
          <button onclick="pagarCarrito()">Proceder al Pago</button>
          <button onclick="cerrarCarrito()">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Sección de historial -->
    <div class="seccion">
      <h2>Mi Historial</h2>
      <button onclick="borrarHistorial()">Borrar historial</button>
      <table id="tablaHistorialCliente">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Libro</th>
            <th>Tipo</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody></tbody> <!-- Aquí se carga el historial -->
      </table>
    </div>

  </div>

  <!-- Modal para seleccionar cantidad -->
  <div id="modalCantidad" class="modal">
    <div class="modal-contenido">
      <h3 id="modalTitulo"></h3>
      <p id="modalSub"></p>
      <input type="number" id="cantidadInput" min="1"> <!-- Cantidad -->
      <div class="modal-botones">
        <button onclick="confirmarCantidad()">Aceptar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal del portal de pago -->
  <div id="checkout" class="modal">
    <div class="modal-contenido">
      <h3>Portal de Pago</h3>
      <form>
        <input type="text" id="tarjeta" placeholder="Número de tarjeta" maxlength="16" oninput="soloNumeros(this)">
        <input type="text" id="expiracion" placeholder="MM/AA" maxlength="5" oninput="formatoExpiracion(this)">
        <input type="text" id="cvv" placeholder="CVV" maxlength="3" oninput="soloNumeros(this)">
        <input type="text" id="titular" placeholder="Nombre del titular">

        <div class="modal-botones">
          <button type="button" onclick="finishPurchase()">Pagar</button>
          <button type="button" onclick="cerrarCheckout()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Usuario activo guardado
    const usuarioActivo = JSON.parse(localStorage.getItem("usuarioActivo"));

    // Datos principales del sistema
    let libros = JSON.parse(localStorage.getItem("libros")) || [];
    let transacciones = JSON.parse(localStorage.getItem("transacciones")) || [];

    // Datos personalizados por usuario
    let historialCliente = usuarioActivo ? (JSON.parse(localStorage.getItem(`historial_${usuarioActivo.usuario}`)) || []) : [];
    let carrito = usuarioActivo ? (JSON.parse(localStorage.getItem(`carrito_${usuarioActivo.usuario}`)) || []) : [];

    // Variables de acción temporal
    let accionPendiente = null;
    let libroSeleccionado = null;
    let indiceSeleccionado = null;
    let compraPendiente = null;

    // Cuando carga la página
    document.addEventListener("DOMContentLoaded", () => {
      mostrarLibrosCliente();
      mostrarHistorialCliente();
      mostrarCarrito();
    });

    // Volver al login
    function volverAlLogin() {
      localStorage.removeItem("rol");
      window.location.href = "login.html";
    }

    // Mensaje emergente
    function mostrarMensaje(tipo, mensaje) {
      const toast = document.createElement('div');
      toast.className = `toast ${tipo}`;
      toast.textContent = mensaje;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Guardar datos en localStorage
    function guardarDatos() {
      localStorage.setItem("libros", JSON.stringify(libros));
      localStorage.setItem("transacciones", JSON.stringify(transacciones));
      if (usuarioActivo) {
        localStorage.setItem(`historial_${usuarioActivo.usuario}`, JSON.stringify(historialCliente));
        localStorage.setItem(`carrito_${usuarioActivo.usuario}`, JSON.stringify(carrito));
      }
    }

    // Mostrar catálogo
    function mostrarLibrosCliente() {
      const contenedor = document.getElementById("catalogoLibros");
      contenedor.innerHTML = "";

      if (libros.length === 0) {
        contenedor.innerHTML = "<p>No hay libros disponibles</p>";
        return;
      }

      libros.forEach((libro, i) => {
        const carta = document.createElement("div");
        carta.className = "carta-libro";

        carta.innerHTML = `
          <img src="${libro.caratula || 'img/sin-imagen.png'}" alt="Portada">
          <h3>${libro.titulo}</h3>
          <p>Autor: ${libro.autor}</p>
          <p>Estado: ${libro.estado}</p>
          <p>Precio: $${libro.precio ? libro.precio.toFixed(2) : 0}</p>
          <p>Stock: ${libro.stock}</p>
          <button onclick="abrirModal('comprar', ${i})">Comprar</button>
          <button onclick="abrirModal('prestamo', ${i})">Pedir Préstamo</button>
          <button onclick="agregarCarrito(${i})">Agregar al Carrito</button>
        `;
        contenedor.appendChild(carta);
      });
    }

    // Mostrar historial
    function mostrarHistorialCliente() {
      const tbody = document.querySelector("#tablaHistorialCliente tbody");
      tbody.innerHTML = "";

      if (historialCliente.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>Aún no tienes transacciones</td></tr>";
        return;
      }

      historialCliente.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td>${t.fecha}</td>
            <td>${t.libro}</td>
            <td>${t.tipo}</td>
            <td>${t.estado}</td>
          </tr>`;
      });
    }

    // Agregar libro al carrito
    function agregarCarrito(i) {
      const libro = libros[i];

      if (libro.stock <= 0) {
        mostrarMensaje('error', 'No hay stock disponible');
        return;
      }

      const existente = carrito.find(item => item.titulo === libro.titulo);
      if (existente) existente.cantidad++;
      else carrito.push({ titulo: libro.titulo, precio: libro.precio, cantidad: 1 });

      guardarDatos();
      mostrarCarrito();
      mostrarMensaje('success', 'Agregado al carrito');
    }

    // Mostrar carrito
    function mostrarCarrito() {
      const tbody = document.querySelector("#tablaCarrito tbody");
      tbody.innerHTML = "";

      if (carrito.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>El carrito está vacío</td></tr>";
        return;
      }

      carrito.forEach((item, i) => {
        const total = item.precio * item.cantidad;
        tbody.innerHTML += `
          <tr>
            <td>${item.titulo}</td>
            <td>${item.cantidad}</td>
            <td>$${item.precio.toFixed(2)}</td>
            <td>$${total.toFixed(2)}</td>
            <td><button onclick="eliminarDelCarrito(${i})">Eliminar</button></td>
          </tr>`;
      });
    }

    // Eliminar un libro del carrito
    function eliminarDelCarrito(i) {
      carrito.splice(i, 1);
      guardarDatos();
      mostrarCarrito();
    }

    // Abrir carrito
    function abrirCarrito() {
      mostrarCarrito();
      document.getElementById('modalCarrito').style.display = 'flex';
    }

    // Cerrar carrito
    function cerrarCarrito() {
      document.getElementById('modalCarrito').style.display = 'none';
    }

  </script>
</body>
</html>
