<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Booknest - Cliente</title>
  <link rel="stylesheet" href="styles.css"> 
</head>
<body>
  <!-- === MEN√ö FLOTANTE (bot√≥n de tres puntos) === -->
<div class="menu-flotante" id="botonMenu">
  <ion-icon name="ellipsis-vertical-outline"></ion-icon>

  <!-- Opciones ocultas -->
  <div class="menu-flotante-opciones2" id="menuOpciones">
    <button class="btn-menu" onclick="verPerfil()">Ver Perfil</button>
    <button class="btn-menu" onclick="volverAlLogin()">Cerrar Sesi√≥n</button>
  </div>
</div>

<!-- Bot√≥n para carrito -->
<header>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <button onclick="abrirCarrito()" class="btn-carrito">
    Mi carrito 
    <ion-icon name="cart-outline"></ion-icon>
    <span id="contadorCarrito" class="contador-carrito">0</span>
  </button>
</header>

<div class="container">

  <!-- CAT√ÅLOGO -->
  <div class="seccion">
    <h2>Cat√°logo de Libros</h2>
    <div id="catalogoLibros" class="catalogo-libros"></div>
  </div>

  

  <!-- MODAL CARRITO -->
  <div id="modalCarrito" class="modal">
    <div class="modal-contenido" style="width: 800px; max-height: 800px; overflow-y: auto;">
      <h3>Carrito de Compras</h3>
      <table id="tablaCarrito">
        <thead>
          <tr>
            <th>Libro</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="text-align: right; margin-top: 10px;">
        <button onclick="pagarCarrito()" style="width:auto; padding:8px 16px;">Proceder al Pago</button>
        <button onclick="cerrarCarrito()" style="width:auto; padding:8px 16px;">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL para ingresar cantidad -->
  <div id="modalCantidad" class="modal">
    <div class="modal-contenido">
      <h3 id="modalTitulo"></h3>
      <p id="modalSub"></p>
      <input type="number" id="cantidadInput" min="1">
      <div class="modal-botones">
        <button onclick="confirmarCantidad()">Aceptar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- PORTAL DE PAGO -->
  <div id="checkout" class="modal">
    <div class="modal-contenido">
      <h3>Portal de Pago</h3>
      <form>
        <input type="text" id="tarjeta" placeholder="N√∫mero de tarjeta" maxlength="16" oninput="detectarTipoTarjeta(this)">
        <small id="tipoTarjeta" style="display:block; margin-top:5px; font-weight:bold;"></small>

        <input type="text" id="expiracion" placeholder="MM/AA" maxlength="5" oninput="formatoExpiracion(this)"><br>
        <input type="text" id="cvv" placeholder="CVV" maxlength="3" oninput="soloNumeros(this)"><br>
        <input type="text" id="titular" placeholder="Nombre del titular"><br>

        <div class="modal-botones">
          <button type="button" onclick="finishPurchase()">Pagar</button>
          <button type="button" onclick="cerrarCheckout()">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

 

<script>
  const usuarioActivo = JSON.parse(localStorage.getItem("usuarioActivo"));
  let libros = JSON.parse(localStorage.getItem("libros")) || [];
  let carrito = usuarioActivo ? (JSON.parse(localStorage.getItem(`carrito_${usuarioActivo.usuario}`)) || []) : [];
  let historialCliente = usuarioActivo ? (JSON.parse(localStorage.getItem(`historial_${usuarioActivo.usuario}`)) || []) : [];
  let transacciones = JSON.parse(localStorage.getItem("transacciones")) || [];

  let accionPendiente = null;
  let libroSeleccionado = null;
  let indiceSeleccionado = null;
  let compraPendiente = null;

  document.addEventListener("DOMContentLoaded", () => {
    mostrarLibrosCliente();
    mostrarCarrito();
    actualizarContadorCarrito();
  });

  function volverAlLogin() { localStorage.removeItem("rol"); window.location.href = "login.html"; }

  function mostrarMensaje(tipo, mensaje) {
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.textContent = mensaje;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function guardarDatos() {
    localStorage.setItem("libros", JSON.stringify(libros));
    localStorage.setItem("transacciones", JSON.stringify(transacciones));
    if (usuarioActivo) {
      localStorage.setItem(`carrito_${usuarioActivo.usuario}`, JSON.stringify(carrito));
      localStorage.setItem(`historial_${usuarioActivo.usuario}`, JSON.stringify(historialCliente));
    }
  }

  function detectarTipoTarjeta(input) {
    const valor = input.value.replace(/\D/g, "");
    const tipoSpan = document.getElementById("tipoTarjeta");
    let tipo = "";

    if (/^4/.test(valor)) tipo = "Visa";
    else if (/^5[1-5]/.test(valor)) tipo = "MasterCard";
    else if (/^3[47]/.test(valor)) tipo = "American Express";
    else if (/^6(?:011|5)/.test(valor)) tipo = "Discover";
    else if (/^35(2[89]|[3-8][0-9])/.test(valor)) tipo = "JCB";
    else if (/^3(?:0[0-5]|[68])/.test(valor)) tipo = "Diners Club";
    else tipo = "";

    tipoSpan.textContent = tipo ? `üí≥ ${tipo}` : "";
  }

  function mostrarLibrosCliente() {
    const contenedor = document.getElementById("catalogoLibros");
    contenedor.innerHTML = "";
    if (libros.length === 0) { contenedor.innerHTML = "<p>No hay libros disponibles</p>"; return; }
    libros.forEach((libro, i) => {
      const carta = document.createElement("div");
      carta.className = "carta-libro";
      carta.innerHTML = `
        <img src="${libro.caratula || 'img/sin-imagen.png'}" alt="Portada">
        <h3>${libro.titulo}</h3>
        <p>Autor: ${libro.autor}</p>
        <p>Estado: ${libro.estado}</p>
         <td>$${libro.precio ? libro.precio.toLocaleString('es-CO') : '0'}</td>
        <p>Stock: ${libro.stock}</p>
        <button onclick="abrirModal('prestamo', ${i})">Pedir Pr√©stamo</button>
        <button onclick="agregarCarrito(${i})">Agregar al Carrito</button>
      `;
      contenedor.appendChild(carta);
    });
  }

  function abrirModal(tipo, i) {
    accionPendiente = tipo;
    libroSeleccionado = libros[i];
    indiceSeleccionado = i;
    document.getElementById('modalTitulo').textContent =
      tipo === 'comprar' ? `Comprar "${libroSeleccionado.titulo}"` : `Pedir pr√©stamo de "${libroSeleccionado.titulo}"`;
    document.getElementById('modalSub').textContent = `Disponible: ${libroSeleccionado.stock} ejemplares`;
    document.getElementById('cantidadInput').value = 1;
    document.getElementById('cantidadInput').max = libroSeleccionado.stock;
    document.getElementById('modalCantidad').style.display = 'flex';
  }

  function cerrarModal() { document.getElementById('modalCantidad').style.display = 'none'; accionPendiente = null; }

  function confirmarCantidad() {
    const cantidad = parseInt(document.getElementById('cantidadInput').value);
    if (isNaN(cantidad) || cantidad <= 0) return;
    if (cantidad > libroSeleccionado.stock) { mostrarMensaje('error', 'Cantidad superior al stock disponible'); return; }
    if (accionPendiente === 'comprar') showCheckout(libroSeleccionado, cantidad);
    else if (accionPendiente === 'prestamo') ejecutarPrestamo(cantidad);
    cerrarModal();
  }

function ejecutarPrestamo(cantidad) {
  const nombreCliente = usuarioActivo ? usuarioActivo.nombre : "Cliente";
  const correoCliente = usuarioActivo ? usuarioActivo.correo : "";
  const fechaInicio = new Date();
  const fechaDevolucion = new Date(fechaInicio);
  fechaDevolucion.setDate(fechaInicio.getDate() + 30); 

  const fechaTexto = fechaInicio.toLocaleString();
  const fechaDevolucionTexto = fechaDevolucion.toLocaleDateString();
 alert(`Recuerda devolver el libro antes del: ${fechaDevolucionTexto} O se le aplicara una multa de 1.500 COP por dia de retraso.`);
  libroSeleccionado.stock -= cantidad;

  // calcular d√≠as restantes desde hoy
  const hoy = new Date();
  const diasRestantes = Math.max(0, Math.ceil((fechaDevolucion - hoy) / (1000 * 60 * 60 * 24)));

  // guardar en transacciones globales (para admin)
  transacciones.push({
    tipo: "prestamo",
    fecha: fechaTexto,
    usuario: nombreCliente,
    correo: correoCliente,
    libro: libroSeleccionado.titulo,
    cantidad,
    fechaDevolucion: fechaDevolucionTexto,
    duracion: diasRestantes
  });
  localStorage.setItem("transacciones", JSON.stringify(transacciones));

  // historial del cliente
  historialCliente.push({
    fecha: fechaTexto,
    libro: libroSeleccionado.titulo,
    tipo: "Pr√©stamo",
    estado: "Activo",
    fechaDevolucion: fechaDevolucionTexto,
    diasRestantes
  });

  guardarDatos();
  mostrarMensaje("success", "Pr√©stamo registrado correctamente");

}

  function agregarCarrito(i) {
    const libro = libros[i];
    if (libro.stock <= 0) { mostrarMensaje('error', 'No hay stock disponible'); return; }
    const existente = carrito.find(item => item.titulo === libro.titulo);
    if (existente) existente.cantidad++;
    else carrito.push({ titulo: libro.titulo, precio: libro.precio, cantidad: 1 });
    guardarDatos();
    mostrarCarrito();
    mostrarMensaje('success', 'Agregado al carrito');
  }

  function mostrarCarrito() {
    const tbody = document.querySelector("#tablaCarrito tbody");
    tbody.innerHTML = "";
    if (carrito.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5'>El carrito est√° vac√≠o</td></tr>";
    } else {
      carrito.forEach((item, i) => {
        const total = item.precio * item.cantidad;
        tbody.innerHTML += `
          <tr>
            <td>${item.titulo}</td>
            <td>${item.cantidad}</td>
            <td>$${item.precio.toFixed(2)}</td>
            <td>$${total.toFixed(2)}</td>
            <td><button onclick="eliminarDelCarrito(${i})">Eliminar</button></td>
          </tr>`;
      });
    }
    actualizarContadorCarrito();
  }

  function eliminarDelCarrito(i) { carrito.splice(i, 1); guardarDatos(); mostrarCarrito(); }

  function pagarCarrito() {
    if (carrito.length === 0) { mostrarMensaje('error', 'El carrito est√° vac√≠o'); return; }
    compraPendiente = { carrito: true };
    document.getElementById('checkout').style.display = 'flex';
  }

  function abrirCarrito() { mostrarCarrito(); document.getElementById('modalCarrito').style.display = 'flex'; }
  function cerrarCarrito() { document.getElementById('modalCarrito').style.display = 'none'; }

  function showCheckout(libro, cantidad) { compraPendiente = { libro, cantidad }; document.getElementById('checkout').style.display = 'flex'; }
  function cerrarCheckout() {
    document.getElementById('checkout').style.display = 'none';
    compraPendiente = null;
    document.getElementById('tarjeta').value = '';
    document.getElementById('expiracion').value = '';
    document.getElementById('cvv').value = '';
    document.getElementById('titular').value = '';
    document.getElementById('tipoTarjeta').textContent = '';
  }

  function soloNumeros(input) { input.value = input.value.replace(/\D/g, ''); }
  function formatoExpiracion(input) { let v = input.value.replace(/\D/g, ''); if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2,4); input.value=v; }

  function finishPurchase() {
    const tarjeta = document.getElementById('tarjeta').value.trim();
    const expiracion = document.getElementById('expiracion').value.trim();
    const cvv = document.getElementById('cvv').value.trim();
    const titular = document.getElementById('titular').value.trim();
    if(!/^\d{16}$/.test(tarjeta) || !/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiracion) || !/^\d{3}$/.test(cvv) || titular.length===0){
      alert("Datos de tarjeta inv√°lidos."); 
      return;
    }

    const nombreCliente = usuarioActivo ? usuarioActivo.nombre : "Cliente";
    const correoCliente = usuarioActivo ? usuarioActivo.correo : "";
    const fecha = new Date().toLocaleString();
    let detalleFactura = [];

    if(compraPendiente && compraPendiente.carrito){
      detalleFactura = carrito.map(item => ({titulo:item.titulo, cantidad:item.cantidad, precio:item.precio}));
      carrito.forEach(item => {
        const libro = libros.find(l => l.titulo === item.titulo);
        if(libro) libro.stock -= item.cantidad;
      });
      carrito = [];
      guardarDatos();
      mostrarMensaje('success','Compra realizada y factura generada');

    } else if(compraPendiente && compraPendiente.libro){
      const {libro, cantidad} = compraPendiente;
      libro.stock -= cantidad;
      detalleFactura = [{titulo:libro.titulo, cantidad, precio:libro.precio}];
      guardarDatos();
      mostrarMensaje('success','Compra realizada y factura generada');
    }

    const totalFactura = detalleFactura.reduce((sum,item) => sum + item.precio*item.cantidad, 0);
    const tipoTarjeta = document.getElementById("tipoTarjeta").textContent.replace("üí≥ ","") || "‚Äî";
    const ultimos4 = tarjeta.slice(-4);

    // Guardar en facturas del usuario
   const facturas = JSON.parse(localStorage.getItem(`facturas_${usuarioActivo.usuario}`)) || [];
const nuevaFactura = {
  id: Date.now(),
  cliente: nombreCliente,
  correo: correoCliente,
  fecha,
  detalle: detalleFactura,
  total: totalFactura,
  tarjetaTipo: tipoTarjeta,
  tarjetaUltimos4: ultimos4
};
facturas.push(nuevaFactura);
localStorage.setItem(`facturas_${usuarioActivo.usuario}`, JSON.stringify(facturas));

//  Esta parte es la que te faltaba:
transacciones.push({
  fecha,
  usuario: nombreCliente,
  correo: correoCliente,
  tipo: "venta",
  libro: detalleFactura.map(d => d.titulo).join(", "), 
  total: totalFactura,
  detalle: detalleFactura
});
localStorage.setItem("transacciones", JSON.stringify(transacciones));

    // Guardar en historial del usuario
    detalleFactura.forEach(item => {
      historialCliente.push({ fecha, libro: item.titulo, tipo: "Compra", estado: "Completada" });
    });
    guardarDatos();

    // Guardar tambi√©n en facturas globales (para admin)
    let facturasGlobales = JSON.parse(localStorage.getItem("facturas")) || [];
    facturasGlobales.push(nuevaFactura);
    localStorage.setItem("facturas", JSON.stringify(facturasGlobales));

    mostrarLibrosCliente(); 
    mostrarCarrito(); 
    cerrarCheckout(); 
    mostrarFacturasGuardadas();
    mostrarMensaje('success','Compra realizada y factura generada');
    compraPendiente = null;
  }

  function verPerfil(){ window.location.href="usuario.html"; }

  const botonMenu=document.getElementById('botonMenu');
  const menuOpciones=document.getElementById('menuOpciones');
  botonMenu.addEventListener('click', e=>{ e.stopPropagation(); menuOpciones.style.display = menuOpciones.style.display==='flex'?'none':'flex'; });
  window.addEventListener('click',()=>{ menuOpciones.style.display='none'; });

  function actualizarContadorCarrito(){
    const contador=document.getElementById("contadorCarrito");
    if(!contador) return;
    const totalItems=carrito.reduce((total,item)=>total+(item.cantidad||1),0);
    contador.textContent=totalItems>0?totalItems:0;
  }

  function toggleFacturas(){
    const seccionTabla=document.getElementById('tablaFacturasCliente');
    seccionTabla.style.display = seccionTabla.style.display==='table'?'none':'table';
    mostrarFacturasGuardadas();
  }

  function mostrarFacturasGuardadas(){
    const tbody=document.querySelector("#tablaFacturasCliente tbody");
    const facturas = JSON.parse(localStorage.getItem(`facturas_${usuarioActivo.usuario}`)) || [];
    tbody.innerHTML="";
    if(facturas.length===0) tbody.innerHTML="<tr><td colspan='4'>No hay facturas</td></tr>";
    else facturas.forEach((f,i)=>{
      tbody.innerHTML+=`<tr>
        <td>${f.id}</td><td>${f.fecha}</td><td>$${f.total.toFixed(2)}</td>
        <td><button onclick="verFactura(${i})">Ver</button></td>
      </tr>`;
    });
  }

  function verFactura(indice){
    const facturas=JSON.parse(localStorage.getItem(`facturas_${usuarioActivo.usuario}`))||[];
    if(!facturas[indice]) return;
    const f=facturas[indice];
    document.getElementById('facturaCliente').textContent=f.cliente;
    document.getElementById('facturaCorreo').textContent=f.correo;
    document.getElementById('facturaFecha').textContent=f.fecha;
    document.getElementById('facturaTipo').textContent=f.tarjetaTipo;
    document.getElementById('facturaUltimos4').textContent=f.tarjetaUltimos4;
    const tbody=document.getElementById('facturaTabla'); tbody.innerHTML="";
    f.detalle.forEach(d=>{ tbody.innerHTML+=`<tr>
      <td>${d.titulo}</td><td>${d.cantidad}</td><td>$${d.precio.toFixed(2)}</td><td>$${(d.cantidad*d.precio).toFixed(2)}</td>
    </tr>`; });
    document.getElementById('facturaTotal').textContent=f.total.toFixed(2);
    document.getElementById('modalFactura').style.display='flex';
  }

  function cerrarModalFactura(){ document.getElementById('modalFactura').style.display='none'; }


function calcularFechaDevolucion(fechaInicio, dias) {
  const [dia, mes, anio] = fechaInicio.split("/");
  const f = new Date(`${anio}-${mes}-${dia}`);
  f.setDate(f.getDate() + dias);
  return `${String(f.getDate()).padStart(2, "0")}/${String(f.getMonth()+1).padStart(2, "0")}/${f.getFullYear()}`;
}

</script>
</div>
</body>
</html>
