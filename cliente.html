<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Booknest - Cliente</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <button class="btn-cerrar" onclick="volverAlLogin()">Cerrar Sesión</button>
  </header>

  <div class="container">
    <!-- Catálogo -->
    <div class="seccion">
      <h2>Catálogo de Libros</h2>
      <table id="tablaLibrosCliente">
        <thead>
          <tr>
            <th>Título</th>
            <th>Autor</th>
            <th>Estado</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Historial -->
    <div class="seccion">
      <h2>Mi Historial</h2>
      <button onclick="borrarHistorial()" style="margin-bottom:10px;">Borrar historial</button>

      <table id="tablaHistorialCliente">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Libro</th>
            <th>Tipo</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal cantidad -->
  <div id="modalCantidad" class="modal">
    <div class="modal-contenido">
      <h3 id="modalTitulo"></h3>
      <p id="modalSub"></p>
      <input type="number" id="cantidadInput" min="1">
      <div class="modal-botones">
        <button onclick="confirmarCantidad()">Aceptar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Portal de pago -->
  <div id="checkout" class="modal">
    <div class="modal-contenido">
      <h3>Portal de Pago</h3>
      <form>
        <input type="text" id="tarjeta" placeholder="Número de tarjeta" maxlength="16" oninput="soloNumeros(this)"><br>
        <input type="text" id="expiracion" placeholder="Fecha de expiración (MM/AA)" maxlength="5" oninput="formatoExpiracion(this)"><br>
        <input type="text" id="cvv" placeholder="CVV" maxlength="3" oninput="soloNumeros(this)"><br>
        <input type="text" id="titular" placeholder="Nombre del titular"><br>
        <div class="modal-botones">
          <button type="button" onclick="finishPurchase()">Pagar</button>
          <button type="button" onclick="cerrarCheckout()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let libros = JSON.parse(localStorage.getItem("libros")) || [];
    let transacciones = JSON.parse(localStorage.getItem("transacciones")) || [];
    let historialCliente = JSON.parse(localStorage.getItem("historialCliente")) || [];

    let accionPendiente = null;
    let libroSeleccionado = null;
    let indiceSeleccionado = null;
    let compraPendiente = null;

    document.addEventListener("DOMContentLoaded", () => {
      mostrarLibrosCliente();
      mostrarHistorialCliente();
    });

    function volverAlLogin() {
      localStorage.removeItem("rol");
      window.location.href = "login.html";
    }

    function mostrarLibrosCliente() {
      const tbody = document.querySelector("#tablaLibrosCliente tbody");
      tbody.innerHTML = "";

      if (libros.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6">No hay libros disponibles</td></tr>`;
        return;
      }

      libros.forEach((libro, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${libro.titulo}</td>
            <td>${libro.autor}</td>
            <td>${libro.estado}</td>
            <td>$${libro.precio ? libro.precio.toFixed(2) : 0}</td>
            <td>${libro.stock}</td>
            <td>
              <button onclick="abrirModal('comprar', ${i})">Comprar</button>
              <button onclick="abrirModal('prestamo', ${i})">Pedir Préstamo</button>
            </td>
          </tr>`;
      });
    }

    function abrirModal(tipo, i) {
      accionPendiente = tipo;
      libroSeleccionado = libros[i];
      indiceSeleccionado = i;
      document.getElementById('modalTitulo').textContent =
        tipo === 'comprar'
          ? `Comprar "${libroSeleccionado.titulo}"`
          : `Pedir préstamo de "${libroSeleccionado.titulo}"`;
      document.getElementById('modalSub').textContent = `Disponible: ${libroSeleccionado.stock} ejemplares`;
      document.getElementById('cantidadInput').value = 1;
      document.getElementById('cantidadInput').max = libroSeleccionado.stock;
      document.getElementById('modalCantidad').style.display = 'flex';
    }

    function cerrarModal() {
      document.getElementById('modalCantidad').style.display = 'none';
      accionPendiente = null;
    }

    function confirmarCantidad() {
      const cantidad = parseInt(document.getElementById('cantidadInput').value);
      if (isNaN(cantidad) || cantidad <= 0) return;
      if (cantidad > libroSeleccionado.stock) {
        mostrarMensaje('error', 'Cantidad superior al stock disponible');
        return;
      }

      if (accionPendiente === 'comprar') showCheckout(libroSeleccionado, cantidad);
      else if (accionPendiente === 'prestamo') ejecutarPrestamo(cantidad);

      cerrarModal();
    }

    function ejecutarPrestamo(cantidad) {
      const usuarioActivo = JSON.parse(localStorage.getItem("usuarioActivo"));
      const nombreCliente = usuarioActivo ? usuarioActivo.nombre : "Cliente";

      libroSeleccionado.stock -= cantidad;
      const fecha = new Date().toLocaleString();

      transacciones.push({
        fecha,
        usuario: nombreCliente,
        libro: libroSeleccionado.titulo,
        tipo: "prestamo",
        cantidad,
        duracion: "7 días"
      });

      historialCliente.push({
        fecha,
        libro: libroSeleccionado.titulo,
        tipo: "Préstamo",
        estado: "Activo"
      });

      guardarDatos();
      mostrarLibrosCliente();
      mostrarHistorialCliente();
      mostrarMensaje('info', `Préstamo registrado (${cantidad} libro/s)`);
    }

    function mostrarHistorialCliente() {
      const tbody = document.querySelector("#tablaHistorialCliente tbody");
      tbody.innerHTML = "";

      if (historialCliente.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">Aún no tienes transacciones</td></tr>`;
        return;
      }

      historialCliente.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td>${t.fecha}</td>
            <td>${t.libro}</td>
            <td>${t.tipo}</td>
            <td>${t.estado}</td>
          </tr>`;
      });
    }

    function guardarDatos() {
      localStorage.setItem("libros", JSON.stringify(libros));
      localStorage.setItem("transacciones", JSON.stringify(transacciones));
      localStorage.setItem("historialCliente", JSON.stringify(historialCliente));
    }

    function mostrarMensaje(tipo, mensaje) {
      const toast = document.createElement('div');
      toast.className = `toast ${tipo}`;
      toast.textContent = mensaje;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Portal de Pago
    function showCheckout(libro, cantidad) {
      compraPendiente = { libro, cantidad };
      document.getElementById('checkout').style.display = 'flex';
    }

    function cerrarCheckout() {
      document.getElementById('checkout').style.display = 'none';
      compraPendiente = null;
      document.getElementById('tarjeta').value = '';
      document.getElementById('expiracion').value = '';
      document.getElementById('cvv').value = '';
      document.getElementById('titular').value = '';
    }

    function soloNumeros(input) {
      input.value = input.value.replace(/\D/g, '');
    }

    function formatoExpiracion(input) {
      let valor = input.value.replace(/\D/g, '');
      if (valor.length > 2) valor = valor.slice(0,2) + '/' + valor.slice(2,4);
      input.value = valor;
    }

    function finishPurchase() {
      if (!compraPendiente) return;

      const usuarioActivo = JSON.parse(localStorage.getItem("usuarioActivo"));
      const nombreCliente = usuarioActivo ? usuarioActivo.nombre : "Cliente";

      const tarjeta = document.getElementById('tarjeta').value.trim();
      const expiracion = document.getElementById('expiracion').value.trim();
      const cvv = document.getElementById('cvv').value.trim();
      const titular = document.getElementById('titular').value.trim();

      if (!/^\d{16}$/.test(tarjeta)) { alert("Número de tarjeta inválido. Debe tener 16 dígitos."); return; }
      if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiracion)) { alert("Fecha inválida (MM/AA)."); return; }
      if (!/^\d{3}$/.test(cvv)) { alert("CVV inválido."); return; }
      if (titular.length === 0) { alert("Ingresa el nombre del titular."); return; }

      const { libro, cantidad } = compraPendiente;
      libro.stock -= cantidad;
      const fecha = new Date().toLocaleString();
      const precioTotal = libro.precio * cantidad;

      transacciones.push({
        fecha,
        usuario: nombreCliente,
        libro: libro.titulo,
        tipo: "venta",
        cantidad,
        precioTotal
      });

      historialCliente.push({
        fecha,
        libro: libro.titulo,
        tipo: "Compra",
        estado: "Completado"
      });

      guardarDatos();
      mostrarLibrosCliente();
      mostrarHistorialCliente();
      mostrarMensaje('success', `Compra realizada (${cantidad} libro/s, total $${precioTotal.toFixed(2)})`);

      cerrarCheckout();
    }

    function borrarHistorial() {
      historialCliente = [];
      localStorage.setItem("historialCliente", JSON.stringify(historialCliente));
      mostrarHistorialCliente();
      mostrarMensaje('info', 'Historial borrado correctamente');
    }
  </script>
</body>
</html>
