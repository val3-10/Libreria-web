<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Booknest - Cliente</title>
  <link rel="stylesheet" href="styles.css"> 
</head>
<body>
  <!-- === MEN√ö FLOTANTE (bot√≥n de tres puntos con opciones del usuario) === -->
  <div class="menu-flotante" id="botonMenu">
    <ion-icon name="ellipsis-vertical-outline"></ion-icon>

    <!-- Opciones del men√∫ (ver perfil o cerrar sesi√≥n) -->
    <div class="menu-flotante-opciones2" id="menuOpciones">
      <button class="btn-menu" onclick="verPerfil()">Ver Perfil</button>
      <button class="btn-menu" onclick="volverAlLogin()">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- === ENCABEZADO con el bot√≥n del carrito === -->
  <header>
    <!-- Librer√≠as de iconos (Ionicons) -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <!-- Bot√≥n del carrito -->
    <button onclick="abrirCarrito()" class="btn-carrito">
      Mi carrito 
      <ion-icon name="cart-outline"></ion-icon>
      <!-- Muestra cu√°ntos productos hay en el carrito -->
      <span id="contadorCarrito" class="contador-carrito">0</span>
    </button>
  </header>

  <div class="container">

    <!-- === SECCI√ìN DE FACTURAS === -->
    <div class="seccion">
      <h2>Mis Facturas</h2>
      <button onclick="toggleFacturas()" style="margin-bottom:10px;">Ver Facturas</button>
      <table id="tablaFacturasCliente">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- === CAT√ÅLOGO DE LIBROS === -->
    <div class="seccion">
      <h2>Cat√°logo de Libros</h2>
      <!-- Aqu√≠ se insertan los libros desde localStorage -->
      <div id="catalogoLibros" class="catalogo-libros"></div>
    </div>

    <!-- === MODAL CARRITO (ventana emergente del carrito) === -->
    <div id="modalCarrito" class="modal">
      <div class="modal-contenido" style="width: 800px; max-height: 800px; overflow-y: auto;">
        <h3>Carrito de Compras</h3>
        <table id="tablaCarrito">
          <thead>
            <tr>
              <th>Libro</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="text-align: right; margin-top: 10px;">
          <button onclick="pagarCarrito()">Proceder al Pago</button>
          <button onclick="cerrarCarrito()">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- === MODAL para ingresar cantidad antes de comprar o pedir pr√©stamo === -->
    <div id="modalCantidad" class="modal">
      <div class="modal-contenido">
        <h3 id="modalTitulo"></h3>
        <p id="modalSub"></p>
        <input type="number" id="cantidadInput" min="1">
        <div class="modal-botones">
          <button onclick="confirmarCantidad()">Aceptar</button>
          <button onclick="cerrarModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- === PORTAL DE PAGO === -->
    <div id="checkout" class="modal">
      <div class="modal-contenido">
        <h3>Portal de Pago</h3>
        <form>
          <!-- Campo del n√∫mero de tarjeta con detecci√≥n autom√°tica -->
          <input type="text" id="tarjeta" placeholder="N√∫mero de tarjeta" maxlength="16" oninput="detectarTipoTarjeta(this)">
          <small id="tipoTarjeta" style="display:block; margin-top:5px; font-weight:bold;"></small>

          <!-- Expiraci√≥n, CVV y titular -->
          <input type="text" id="expiracion" placeholder="MM/AA" maxlength="5" oninput="formatoExpiracion(this)"><br>
          <input type="text" id="cvv" placeholder="CVV" maxlength="3" oninput="soloNumeros(this)"><br>
          <input type="text" id="titular" placeholder="Nombre del titular"><br>

          <!-- Botones de pago -->
          <div class="modal-botones">
            <button type="button" onclick="finishPurchase()">Pagar</button>
            <button type="button" onclick="cerrarCheckout()">Cerrar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- === MODAL FACTURA (visualizaci√≥n de factura generada) === -->
    <div id="modalFactura" class="modal">
      <div class="modal-contenido" style="width: 600px; max-height: 700px; overflow-y: auto;">
        <h3>Factura de Compra</h3>
        <p><strong>Cliente:</strong> <span id="facturaCliente"></span></p>
        <p><strong>Correo:</strong> <span id="facturaCorreo"></span></p>
        <p><strong>Fecha:</strong> <span id="facturaFecha"></span></p>
        <p><strong>Tipo de tarjeta:</strong> <span id="facturaTipo"></span></p>
        <p><strong>√öltimos 4 d√≠gitos:</strong> <span id="facturaUltimos4"></span></p>

        <!-- Tabla de los libros comprados -->
        <table border="1" width="100%" style="border-collapse: collapse; margin-top: 10px;">
          <thead>
            <tr>
              <th>Libro</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="facturaTabla"></tbody>
        </table>

        <h4 style="text-align: right; margin-top: 10px;">Total: $<span id="facturaTotal">0.00</span></h4>

        <div class="modal-botones">
          <button onclick="cerrarModalFactura()">Cerrar</button>
        </div>
      </div>
    </div>

<script>
  /* === VARIABLES GLOBALES === */
  const usuarioActivo = JSON.parse(localStorage.getItem("usuarioActivo"));
  let libros = JSON.parse(localStorage.getItem("libros")) || [];
  let carrito = usuarioActivo ? (JSON.parse(localStorage.getItem(`carrito_${usuarioActivo.usuario}`)) || []) : [];
  let historialCliente = usuarioActivo ? (JSON.parse(localStorage.getItem(`historial_${usuarioActivo.usuario}`)) || []) : [];
  let transacciones = JSON.parse(localStorage.getItem("transacciones")) || [];

  // Variables de control
  let accionPendiente = null;
  let libroSeleccionado = null;
  let indiceSeleccionado = null;
  let compraPendiente = null;

  // === Cuando la p√°gina carga ===
  document.addEventListener("DOMContentLoaded", () => {
    mostrarLibrosCliente();
    mostrarCarrito();
    actualizarContadorCarrito();
  });

  /* === CERRAR SESI√ìN === */
  function volverAlLogin() {
    localStorage.removeItem("rol");
    window.location.href = "login.html";
  }

  /* === MENSAJES FLOTANTES (tipo "toast") === */
  function mostrarMensaje(tipo, mensaje) {
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.textContent = mensaje;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  /* === GUARDAR DATOS EN LOCALSTORAGE === */
  function guardarDatos() {
    localStorage.setItem("libros", JSON.stringify(libros));
    localStorage.setItem("transacciones", JSON.stringify(transacciones));
    if (usuarioActivo) {
      localStorage.setItem(`carrito_${usuarioActivo.usuario}`, JSON.stringify(carrito));
      localStorage.setItem(`historial_${usuarioActivo.usuario}`, JSON.stringify(historialCliente));
    }
  }

  /* === DETECTAR TIPO DE TARJETA AUTOM√ÅTICAMENTE === */
  function detectarTipoTarjeta(input) {
    const valor = input.value.replace(/\D/g, "");
    const tipoSpan = document.getElementById("tipoTarjeta");
    let tipo = "";

    if (/^4/.test(valor)) tipo = "Visa";
    else if (/^5[1-5]/.test(valor)) tipo = "MasterCard";
    else if (/^3[47]/.test(valor)) tipo = "American Express";
    else if (/^6(?:011|5)/.test(valor)) tipo = "Discover";
    else if (/^35(2[89]|[3-8][0-9])/.test(valor)) tipo = "JCB";
    else if (/^3(?:0[0-5]|[68])/.test(valor)) tipo = "Diners Club";

    tipoSpan.textContent = tipo ? `üí≥ ${tipo}` : "";
  }

  /* === MOSTRAR LIBROS DISPONIBLES === */
  function mostrarLibrosCliente() {
    const contenedor = document.getElementById("catalogoLibros");
    contenedor.innerHTML = "";

    if (libros.length === 0) {
      contenedor.innerHTML = "<p>No hay libros disponibles</p>";
      return;
    }

    libros.forEach((libro, i) => {
      const carta = document.createElement("div");
      carta.className = "carta-libro";
      carta.innerHTML = `
        <img src="${libro.caratula || 'img/sin-imagen.png'}" alt="Portada">
        <h3>${libro.titulo}</h3>
        <p>Autor: ${libro.autor}</p>
        <p>Estado: ${libro.estado}</p>
        <p>Precio: $${libro.precio ? libro.precio.toFixed(2) : 0}</p>
        <p>Stock: ${libro.stock}</p>
        <button onclick="abrirModal('comprar', ${i})">Comprar</button>
        <button onclick="abrirModal('prestamo', ${i})">Pedir Pr√©stamo</button>
        <button onclick="agregarCarrito(${i})">Agregar al Carrito</button>
      `;
      contenedor.appendChild(carta);
    });
  }

  /* === ABRIR Y CERRAR MODAL DE CANTIDAD === */
  function abrirModal(tipo, i) {
    accionPendiente = tipo;
    libroSeleccionado = libros[i];
    indiceSeleccionado = i;
    document.getElementById('modalTitulo').textContent =
      tipo === 'comprar' ? `Comprar "${libroSeleccionado.titulo}"` : `Pedir pr√©stamo de "${libroSeleccionado.titulo}"`;
    document.getElementById('modalSub').textContent = `Disponible: ${libroSeleccionado.stock} ejemplares`;
    document.getElementById('cantidadInput').value = 1;
    document.getElementById('cantidadInput').max = libroSeleccionado.stock;
    document.getElementById('modalCantidad').style.display = 'flex';
  }

  function cerrarModal() {
    document.getElementById('modalCantidad').style.display = 'none';
    accionPendiente = null;
  }

  /* === CONFIRMAR CANTIDAD Y ACCI√ìN (compra o pr√©stamo) === */
  function confirmarCantidad() {
    const cantidad = parseInt(document.getElementById('cantidadInput').value);
    if (isNaN(cantidad) || cantidad <= 0) return;
    if (cantidad > libroSeleccionado.stock) {
      mostrarMensaje('error', 'Cantidad superior al stock disponible');
      return;
    }
    if (accionPendiente === 'comprar') showCheckout(libroSeleccionado, cantidad);
    else if (accionPendiente === 'prestamo') ejecutarPrestamo(cantidad);
    cerrarModal();
  }

  /* === REGISTRAR UN PR√âSTAMO === */
  function ejecutarPrestamo(cantidad) {
    const nombreCliente = usuarioActivo ? usuarioActivo.nombre : "Cliente";
    const correoCliente = usuarioActivo ? usuarioActivo.correo : "";
    const fecha = new Date().toLocaleString();

    libroSeleccionado.stock -= cantidad;

    // Guardar transacci√≥n
    transacciones.push({
      fecha, usuario: nombreCliente, correo: correoCliente,
      libro: libroSeleccionado.titulo, tipo: "prestamo",
      cantidad, duracion: "7 d√≠as"
    });

    historialCliente.push({ fecha, libro: libroSeleccionado.titulo, tipo: "Pr√©stamo", estado: "Activo" });
    guardarDatos();
  }

  /* === CARRITO === */
  function agregarCarrito(i) {
    const libro = libros[i];
    if (libro.stock <= 0) { mostrarMensaje('error', 'No hay stock disponible'); return; }
    const existente = carrito.find(item => item.titulo === libro.titulo);
    if (existente) existente.cantidad++;
    else carrito.push({ titulo: libro.titulo, precio: libro.precio, cantidad: 1 });
    guardarDatos();
    mostrarCarrito();
    mostrarMensaje('success', 'Agregado al carrito');
  }

  /* === MOSTRAR CARRITO === */
  function mostrarCarrito() {
    const tbody = document.querySelector("#tablaCarrito tbody");
    tbody.innerHTML = "";
    if (carrito.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5'>El carrito est√° vac√≠o</td></tr>";
    } else {
      carrito.forEach((item, i) => {
        const total = item.precio * item.cantidad;
        tbody.innerHTML += `
          <tr>
            <td>${item.titulo}</td>
            <td>${item.cantidad}</td>
            <td>$${item.precio.toFixed(2)}</td>
            <td>$${total.toFixed(2)}</td>
            <td><button onclick="eliminarDelCarrito(${i})">Eliminar</button></td>
          </tr>`;
      });
    }
    actualizarContadorCarrito();
  }

  /* === ELIMINAR UN PRODUCTO DEL CARRITO === */
  function eliminarDelCarrito(i) {
    carrito.splice(i, 1);
    guardarDatos();
    mostrarCarrito();
  }

  /* === PAGAR EL CARRITO === */
  function pagarCarrito() {
    if (carrito.length === 0) { mostrarMensaje('error', 'El carrito est√° vac√≠o'); return; }
    compraPendiente = { carrito: true };
    document.getElementById('checkout').style.display = 'flex';
  }

  /* === ABRIR Y CERRAR MODALES === */
  function abrirCarrito() { mostrarCarrito(); document.getElementById('modalCarrito').style.display = 'flex'; }
  function cerrarCarrito() { document.getElementById('modalCarrito').style.display = 'none'; }
  function showCheckout(libro, cantidad) { compraPendiente = { libro, cantidad }; document.getElementById('checkout').style.display = 'flex'; }
  function cerrarCheckout() {
    document.getElementById('checkout').style.display = 'none';
    compraPendiente = null;
    document.getElementById('tarjeta').value = '';
    document.getElementById('expiracion').value = '';
    document.getElementById('cvv').value = '';
    document.getElementById('titular').value = '';
    document.getElementById('tipoTarjeta').textContent = '';
  }

  /* === VALIDACIONES DE FORMATO === */
  function soloNumeros(input) { input.value = input.value.replace(/\D/g, ''); }
  function formatoExpiracion(input) {
    let v = input.value.replace(/\D/g, '');
    if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2,4);
    input.value=v;
  }

  /* === FINALIZAR COMPRA Y GENERAR FACTURA === */
  function finishPurchase() {
    const tarjeta = document.getElementById('tarjeta').value.trim();
    const expiracion = document.getElementById('expiracion').value.trim();
    const cvv = document.getElementById('cvv').value.trim();
    const titular = document.getElementById('titular').value.trim();
    // Validar datos de la tarjeta
    if(!/^\d{16}$/.test(tarjeta)||!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiracion)||!/^\d{3}$/.test(cvv)||titular.length===0){
      alert("Datos de tarjeta inv√°lidos."); return;
    }

    // Datos del cliente
    const nombreCliente = usuarioActivo ? usuarioActivo.nombre : "Cliente";
    const correoCliente = usuarioActivo ? usuarioActivo.correo : "";
    const fecha = new Date().toLocaleString();
    let detalleFactura = [];

    // Si paga carrito o libro individual
    if(compraPendiente && compraPendiente.carrito){
      detalleFactura = carrito.map(item=>({titulo:item.titulo,cantidad:item.cantidad,precio:item.precio}));
      carrito.forEach(item=>{ const libro = libros.find(l=>l.titulo===item.titulo); if(libro) libro.stock -= item.cantidad; });
      carrito = [];
      guardarDatos();
    } else if(compraPendiente && compraPendiente.libro){
      const {libro,cantidad}=compraPendiente;
      libro.stock -= cantidad;
      detalleFactura=[{titulo:libro.titulo,cantidad,precio:libro.precio}];
      guardarDatos();
    }

    const total = detalleFactura.reduce((sum,item)=>sum+(item.precio*item.cantidad),0);
    const tipoTarjeta = document.getElementById("tipoTarjeta").textContent.replace("üí≥ ","");
    const ultimos4 = tarjeta.slice(-4);
    const factura={id:Date.now(),cliente:nombreCliente,correo:correoCliente,fecha,total,detalle:detalleFactura,tipoTarjeta,ultimos4};

    transacciones.push(factura);
    historialCliente.push({fecha,tipo:"Compra",total});
    guardarDatos();

    mostrarFactura(factura);
    cerrarCheckout();
  }

  /* === MOSTRAR FACTURA === */
  function mostrarFactura(factura){
    document.getElementById("facturaCliente").textContent = factura.cliente;
    document.getElementById("facturaCorreo").textContent = factura.correo;
    document.getElementById("facturaFecha").textContent = factura.fecha;
    document.getElementById("facturaTipo").textContent = factura.tipoTarjeta;
    document.getElementById("facturaUltimos4").textContent = factura.ultimos4;
    document.getElementById("facturaTotal").textContent = factura.total.toFixed(2);

    const tbody=document.getElementById("facturaTabla");
    tbody.innerHTML="";
    factura.detalle.forEach(item=>{
      tbody.innerHTML+=`
        <tr>
          <td>${item.titulo}</td>
          <td>${item.cantidad}</td>
          <td>$${item.precio.toFixed(2)}</td>
          <td>$${(item.cantidad*item.precio).toFixed(2)}</td>
        </tr>`;
    });

    document.getElementById("modalFactura").style.display="flex";
  }

  function cerrarModalFactura(){
    document.getElementById("modalFactura").style.display="none";
    mostrarLibrosCliente();
    mostrarCarrito();
    actualizarContadorCarrito();
  }

  /* === MOSTRAR Y OCULTAR FACTURAS === */
  function toggleFacturas(){
    const tablaBody=document.querySelector("#tablaFacturasCliente tbody");
    tablaBody.innerHTML="";
    const facturas=transacciones.filter(t=>t.cliente===usuarioActivo?.nombre);
    if(facturas.length===0){tablaBody.innerHTML="<tr><td colspan='4'>No hay facturas</td></tr>"; return;}
    facturas.forEach(f=>{
      tablaBody.innerHTML+=`
        <tr>
          <td>${f.id}</td>
          <td>${f.fecha}</td>
          <td>$${f.total.toFixed(2)}</td>
          <td><button onclick='mostrarFactura(${JSON.stringify(f)})'>Ver</button></td>
        </tr>`;
    });
  }

  /* === PERFIL === */
  function verPerfil(){
    alert(`Usuario: ${usuarioActivo?.nombre}\nCorreo: ${usuarioActivo?.correo}`);
  }

  /* === CONTADOR DEL CARRITO === */
  function actualizarContadorCarrito(){
    document.getElementById("contadorCarrito").textContent=carrito.reduce((sum,item)=>sum+item.cantidad,0);
  }
</script>
</body>
</html>
